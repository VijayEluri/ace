<project name="dev-server" default="warning">
    <property name="deploy-dir" value="deploy/target/${ant.project.name}" />
	<property name="app-name" value="L-iQ PS server" />

    <target name="warning">
        <echo message="Please run top level build." />
    </target>
    
    <target name="deploy">
        <mkdir dir="${deploy-dir}" />
        <mkdir dir="${deploy-dir}/store" />
        <copy todir="${deploy-dir}">
            <fileset dir="lib/felix/1.8.1">
                <include name="**" />
            </fileset>
        </copy>
        <copy todir="${deploy-dir}/bundle">
            <fileset dir="deploy/bundle">
            	<include name="org.apache.ace.consolelogger-1.0.0.jar" />
            	<include name="org.apache.ace.configurator-1.0.0.jar" />
            	<include name="org.apache.ace.configurator.useradmin.task-1.0.0.jar" />
            	<include name="org.apache.ace.resourceprocessor.useradmin-1.0.0.jar" />
            	<include name="org.apache.ace.http.listener-1.0.0.jar" />
            	<include name="org.apache.ace.deployment.servlet-1.0.0.jar" />
            	<include name="org.apache.ace.deployment.provider.repositorybased-1.0.0.jar" />
            	<include name="org.apache.ace.deployment.streamgenerator-1.0.0.jar" />
            	<include name="org.apache.ace.discovery.property-1.0.0.jar" />
            	<include name="org.apache.ace.server.log.store-1.0.0.jar" />
            	<include name="org.apache.ace.server.log-1.0.0.jar" />
            	<include name="org.apache.ace.scheduler-1.0.0.jar" />
            	<include name="org.apache.ace.repository-1.0.0.jar" />
            	<include name="org.apache.ace.repository.servlet-1.0.0.jar" />
                <include name="org.apache.ace.client.repository.stateful-1.0.0.jar" />
                <include name="org.apache.ace.client.repository-1.0.0.jar" />
                <include name="org.apache.ace.client.repository.helper.base-1.0.0.jar" />
                <include name="org.apache.ace.client.repository.helper.bundle-1.0.0.jar" />
                <include name="org.apache.ace.activation.store-1.0.0.jar" />
                <include name="org.apache.ace.activationinfo.store-1.0.0.jar" />
                <include name="org.apache.ace.activation.matcher-1.0.0.jar" />
                <include name="org.apache.ace.activation.servlet-1.0.0.jar" />
                <include name="org.apache.ace.activation.service-1.0.0.jar" />
                <include name="org.apache.ace.client.repository.helper.license-1.0.0.jar" />
                <!-- for testing -->
                <!--
                <include name="org.apache.ace.http.echo.servlet-1.0.0.jar" />
                -->
            </fileset>
            <fileset dir="ext">
            	<include name="org.osgi.compendium.jar" />
                <include name="osgi.mobile.jar" />
                <include name="javax.servlet.jar" />
                <include name="org.apache.felix.dependencymanager.jar" />
                <include name="org.apache.felix.dependencymanager.shell.jar" />
            </fileset>
            <fileset dir="lib">
                <include name="org.apache.ace.xstream-1.3.jar" />
                <include name="org.apache.felix.configadmin.jar" />
                <include name="org.apache.felix.eventadmin.jar" />
                <include name="log_all-2.0.0.jar" />
                <include name="http.jetty.jar" />
            	<include name="useradmin_all-2.0.0.jar" />
            	<include name="org.apache.felix.prefs.jar" />
            </fileset>
        </copy>
        <copy todir="${deploy-dir}/conf">
            <fileset dir="conf/${ant.project.name}">
                <include name="**/*.cfg" />
            </fileset>
        </copy>
        <copy file="${deploy-dir}/conf/dev-config.properties" overwrite="true" tofile="${deploy-dir}/conf/config.properties" />
        <delete file="${deploy-dir}/conf/test-config.properties" />
        <property name="bundles-noshell" value="
        	file:bundle/org.apache.ace.consolelogger-1.0.0.jar
        	file:bundle/log_all-2.0.0.jar
            file:bundle/osgi.mobile.jar 
            file:bundle/org.osgi.compendium.jar 
            file:bundle/http.jetty.jar
            file:bundle/javax.servlet.jar
        	file:bundle/useradmin_all-2.0.0.jar
            file:bundle/org.apache.ace.xstream-1.3.jar
    	    file:bundle/org.apache.felix.eventadmin.jar
        	file:bundle/org.apache.felix.configadmin.jar 
            file:bundle/org.apache.felix.dependencymanager.jar 
            file:bundle/org.apache.felix.prefs.jar
            file:bundle/org.apache.ace.configurator-1.0.0.jar
            file:bundle/org.apache.ace.http.listener-1.0.0.jar
            file:bundle/org.apache.ace.deployment.servlet-1.0.0.jar
            file:bundle/org.apache.ace.deployment.provider.repositorybased-1.0.0.jar
            file:bundle/org.apache.ace.deployment.streamgenerator-1.0.0.jar
        	file:bundle/org.apache.ace.discovery.property-1.0.0.jar
            file:bundle/org.apache.ace.server.log.store-1.0.0.jar
            file:bundle/org.apache.ace.server.log-1.0.0.jar
            file:bundle/org.apache.ace.scheduler-1.0.0.jar
            file:bundle/org.apache.ace.repository-1.0.0.jar
            file:bundle/org.apache.ace.repository.servlet-1.0.0.jar
    	    file:bundle/org.apache.ace.client.repository.stateful-1.0.0.jar
    	    file:bundle/org.apache.ace.client.repository-1.0.0.jar
            file:bundle/org.apache.ace.client.repository.helper.base-1.0.0.jar
            file:bundle/org.apache.ace.client.repository.helper.bundle-1.0.0.jar
            file:bundle/org.apache.ace.configurator.useradmin.task-1.0.0.jar
        	file:bundle/org.apache.ace.resourceprocessor.useradmin-1.0.0.jar
            file:bundle/org.apache.ace.activation.store-1.0.0.jar
            file:bundle/org.apache.ace.activationinfo.store-1.0.0.jar
            file:bundle/org.apache.ace.activation.matcher-1.0.0.jar
            file:bundle/org.apache.ace.activation.servlet-1.0.0.jar
            file:bundle/org.apache.ace.activation.service-1.0.0.jar
            file:bundle/org.apache.ace.client.repository.helper.license-1.0.0.jar
            " />
        <property name="bundles-shell" value="${bundles-noshell}
            file:bundle/org.apache.felix.shell-1.2.0.jar 
            file:bundle/org.apache.felix.shell.tui-1.2.0.jar
            file:bundle/org.apache.felix.dependencymanager.shell.jar 
            " />
        <replace file="${deploy-dir}/conf/config.properties" token="@bundles@" value="${bundles-shell}" />
        <move file="${deploy-dir}/conf/dev-config.properties" tofile="${deploy-dir}/conf/config-noshell.properties" />
        <replace file="${deploy-dir}/conf/config-noshell.properties" token="@bundles@" value="${bundles-noshell}" />
        <replace file="${deploy-dir}/conf/config.properties" token="@properties@">
            <replacevalue><![CDATA[
org.apache.felix.http.nio=true
org.apache.felix.http.enable=true
org.osgi.service.http.port=8080
org.apache.felix.https.enable=false
org.osgi.service.http.port.secure=8443
org.apache.felix.http.debug=false
org.apache.felix.https.keystore=/tmp/node1Keystore
org.apache.felix.https.keystore.password=secret
org.apache.felix.https.keystore.key.password=secret
org.apache.felix.https.truststore=/tmp/truststore
org.apache.felix.https.truststore.password=secret
org.apache.felix.https.clientcertificate=needs
                ]]></replacevalue>
        </replace>
        <replace file="${deploy-dir}/conf/config-noshell.properties" token="@properties@">
            <replacevalue><![CDATA[
org.apache.felix.http.nio=true
org.apache.felix.http.enable=true
org.osgi.service.http.port=8080
org.apache.felix.https.enable=false
org.osgi.service.http.port.secure=8443
org.apache.felix.http.debug=false
org.apache.felix.https.keystore=/tmp/node1Keystore
org.apache.felix.https.keystore.password=secret
org.apache.felix.https.keystore.key.password=secret
org.apache.felix.https.truststore=/tmp/truststore
org.apache.felix.https.truststore.password=secret
org.apache.felix.https.clientcertificate=needs
            ]]></replacevalue>
        </replace>

        <property name="runCommand" value="java -Xms256m -Xmx256m -jar bin/felix.jar"/>
    	<property name="runNoshellCommand" value="java -Xms256m -Xmx256m -Dfelix.config.properties=file:conf/config-noshell.properties -jar bin/felix.jar > output-felix.txt 2>&amp;1"/>
    	<property name="debugCommand" value="java -Xms256m -Xmx256m -jar -Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=y -Dcom.sun.management.jmxremote.port=6666 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false bin/felix.jar"/>
    	<echo file="${deploy-dir}/run.sh">#!/bin/sh
${runCommand}
        </echo>
		<echo file="${deploy-dir}/run.bat">${runCommand}
        </echo>
    	<echo file="${deploy-dir}/run-noshell.sh">#!/bin/sh
${runNoshellCommand}
        </echo>
		<echo file="${deploy-dir}/run-noshell.bat">${runNoshellCommand}
        </echo>
        <echo file="${deploy-dir}/debug.sh">#!/bin/sh
${debugCommand}
        </echo>
        <echo file="${deploy-dir}/debug.bat">${debugCommand}
        </echo>
        <echo file="${deploy-dir}/run_secure.sh">#!/bin/sh
${runSecureCommand}
        </echo>
	    <!-- Include new targets from ACE-32 -->
		 <antcall target="standalone" />
		 <antcall target="paxrunner" />
    </target>

	<!-- 
		The following targets are standalone - proof of concept - examples for Jira ACE-32 
		Those targets can, once "accepted" be integrated into the generic dev-* build loop.
		
		See Comments at https://issues.apache.org/jira/browse/ACE-32 for description.
	-->

	<property name="workdir" value="deploy/target/dev-server" />

	<!-- Creates a dynamic deployment for Pax Runner. (1a Option in my mail) -->
	<target name="paxrunner">
		<mkdir dir="${workdir}/paxrunner" />

		<echo file="${workdir}/paxrunner/run.sh">java -jar ../../../../lib/pax-runner-1.1.1.jar --vmo='-Dorg.apache.ace.configurator.CONFIG_DIR=../../conf' --clean --log=debug --args=file:../../../../conf/dev-server/platform.setup scan-file:file:../../../../conf/dev-server/platform.properties ../bundle</echo>
			<echo file="${workdir}/paxrunner/run.bat">java -jar ../../../../lib/pax-runner-1.1.1.jar --vmo='-Dorg.apache.ace.configurator.CONFIG_DIR=../../conf' --clean --log=debug --args=file:../../../../conf/dev-server/platform.setup scan-file:file:../../../../conf/dev-server/platform.properties ../bundle</echo>
	</target>

	<!-- Creates a static deployment using Pax Runner. (1b Option in my mail) -->
	<!-- This is routly the "same" output as the current setup but giving framework indepenence at build time -->
	 <target name="standalone">
		<mkdir dir="${workdir}/standalone" />

		<java dir="." classname="org.ops4j.pax.runner.Run" fork="true" taskname="paxrunner" timeout="99999" failonerror="true">
	        <arg value="--args=file:conf/dev-server/platform.setup"/>
	 		<arg value="--executor=script"/>
			<arg value="--vmo='-Dorg.apache.ace.configurator.CONFIG_DIR=../conf'"/>
	 		<arg value="--clean"/>
			<arg value="--workingDirectory=${workdir}/standalone"/>
			<arg value="scan-file:file:conf/dev-server/platform.properties"/>
			<arg value="${workdir}/bundle"/>
			<classpath>
	          <pathelement location="lib/pax-runner-1.1.1.jar"/>
	        </classpath>
	      </java>
	  </target>
</project>

<?xml version="1.0" encoding="UTF-8"?>
<project name="bin-build" default="package">
	<import file="../cnf/build.xml" />

	<property name="version" value="1.0.0" />

	<property name="target.base.dir" value="generated/apache-ace-${version}" />
	<property name="target.server-allinone.dir" value="${target.base.dir}/server-allinone" />
	<property name="target.server.dir" value="${target.base.dir}/server" />
	<property name="target.client.dir" value="${target.base.dir}/client" />
	<property name="target.obr.dir" value="${target.base.dir}/obr" />
	<property name="target.target.dir" value="${target.base.dir}/target" />
	<property name="server.zipball" value="generated/apache-ace-${version}.zip" />
	<property name="server.tarball" value="generated/apache-ace-${version}.tar.gz" />

	<target name="package" description="Packages ACE into a binary distribution." depends="init">
		<mkdir dir="${target.server.dir}" />
		<mkdir dir="${target.server-allinone.dir}" />
		<mkdir dir="${target.client.dir}" />
		<mkdir dir="${target.obr.dir}" />
		<mkdir dir="${target.target.dir}" />

		<resources id="devserver-store">
			<file file="../cnf/localrepo/org.apache.felix.deployment.rp.autoconf/org.apache.felix.deployment.rp.autoconf-0.1.1.jar" />
			<file file="../org.apache.ace.launcher/generated/org.apache.ace.launcher.jar" />
		</resources>

		<!-- copy the configuration files -->
		<copy todir="${target.server-allinone.dir}/conf">
			<fileset dir="../run-server-allinone/conf" />
		</copy>
		<copy todir="${target.server.dir}/conf">
			<fileset dir="../run-server/conf" />
		</copy>
		<copy todir="${target.client.dir}/conf">
			<fileset dir="../run-client/conf" />
		</copy>
		<copy todir="${target.obr.dir}/conf">
			<fileset dir="../run-obr/conf" />
		</copy>

		<!-- add jar files to store directory -->
		<copy todir="${target.server.dir}/store" flatten="true">
			<resources refid="devserver-store" />
		</copy>
		<move file="${target.server.dir}/store/org.apache.ace.launcher.jar" toFile="${target.server.dir}/store/ace-launcher.jar"/>

		<copy todir="${target.server-allinone.dir}/store" flatten="true">
			<resources refid="devserver-store" />
		</copy>
		<move file="${target.server-allinone.dir}/store/org.apache.ace.launcher.jar" toFile="${target.server-allinone.dir}/store/ace-launcher.jar"/>

		<!-- create the executable jars -->
		<bndpackage runfile="../run-server-allinone/server-allinone.bndrun" output="${target.server-allinone.dir}/server-allinone.jar" />
		<bndpackage runfile="../run-server/server.bndrun" output="${target.server.dir}/server.jar" />
		<bndpackage runfile="../run-client/client.bndrun" output="${target.client.dir}/client.jar" />
		<bndpackage runfile="../run-obr/obr.bndrun" output="${target.obr.dir}/obr.jar" />
		<bndpackage runfile="../run-target/target.bndrun" output="${target.target.dir}/target.jar" />

		<!-- create one giant TAR.GZ-file with everything in it -->
		<tar destfile="${server.tarball}" compression="gzip">
			<tarfileset dir="${target.server.dir}" prefix="ace-devserver">
				<include name="**"/>
				<exclude name="*.sh"/>
			</tarfileset>
			<tarfileset dir="${target.server.dir}" mode="755" prefix="ace-devserver">
				<include name="*.sh"/>
			</tarfileset>
		</tar>

		<!-- create one giant ZIP-file with everything in it -->
		<zip destfile="${server.zipball}">
			<tarfileset dir="${target.server.dir}" prefix="ace-devserver">
				<include name="**"/>
				<exclude name="*.sh"/>
			</tarfileset>
			<tarfileset dir="${target.server.dir}" prefix="ace-devserver">
				<include name="*.sh"/>
			</tarfileset>
		</zip>
	</target>

	<target name="package-target">
		<resources id="target-bundles">
			<url url="http://bundles.bndtools.org.s3.amazonaws.com/org.apache.felix.gogo.command/org.apache.felix.gogo.command-0.12.0.jar" />
			<url url="http://bundles.bndtools.org.s3.amazonaws.com/org.apache.felix.gogo.runtime/org.apache.felix.gogo.runtime-0.10.0.jar" />
			<url url="http://bundles.bndtools.org.s3.amazonaws.com/org.apache.felix.gogo.shell/org.apache.felix.gogo.shell-0.10.0.jar" />
			<file file="../org.apache.ace.managementagent/generated/org.apache.ace.managementagent.jar" />
		</resources>

		<copy todir="${target.target.dir}" flatten="true">
			<resources refid="target-bundles" />
		</copy>
	</target>
</project>
